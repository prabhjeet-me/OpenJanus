#user  nobody;
#worker_processes 1;

# Enables the use of JIT for regular expressions to speed-up their processing.
pcre_jit on;

error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

pid        logs/nginx.pid;

events {
  worker_connections  1024;
}

stream {
  # Docker DNS resolver. Helpful in for resolving non-reachable host
  # First set $var="http://someapp:4000"
  # proxy_pass $var;
  # Avoids container crashes
  resolver 127.0.0.11 valid=30s;

  # Include stream configs
  include /etc/nginx/stream.d/*.conf;
}

http {
  # -------- Core Security Headers --------
  more_set_headers "Content-Security-Policy: default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'self'; object-src 'none'; base-uri 'self';";
  more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";
  more_set_headers "X-Frame-Options: SAMEORIGIN";
  more_set_headers "X-Content-Type-Options: nosniff";
  more_set_headers "Referrer-Policy: strict-origin-when-cross-origin" ;
  more_set_headers "X-XSS-Protection: 1; mode=block";

  # -------- Modern Privacy & Isolation --------
  more_set_headers "Permissions-Policy: camera=(), microphone=(), geolocation=(), fullscreen=()";
  more_set_headers "Cross-Origin-Opener-Policy: same-origin";
  more_set_headers "Cross-Origin-Embedder-Policy: require-corp";
  more_set_headers "Cross-Origin-Resource-Policy: same-origin";
  more_set_headers "Origin-Agent-Cluster: ?1";

  # -------- Optional / Misc / Cache Control --------
  more_set_headers "Cache-Control: no-store, no-cache, must-revalidate";
  more_set_headers "Pragma: no-cache";
  more_set_headers "X-Permitted-Cross-Domain-Policies: none";

  root /usr/local/openresty/nginx/html;

  error_page 301 302 303 307 308              /30x.html;
  error_page 405 408 410 413 414              /40x.html;
  error_page  400              /400.html;
  error_page  401              /401.html;
  error_page  403              /403.html;
  error_page  404              /404.html;

  # redirect server error pages to the static page /50x.html
  #
  error_page  500 501 502 503 504 505  /50x.html;

  # Docker DNS resolver. Helpful in for resolving non-reachable host
  # First set $var="http://someapp:4000"
  # proxy_pass $var;
  resolver 127.0.0.11 valid=30s;

  # Prevents directory listings
  autoindex off;

  # Override upstream 50x errors
  proxy_intercept_errors on;

  # Normal traffic limit - allow 30 requests per second with burst up to 20 per IP
  limit_req_zone $binary_remote_addr zone=perip:20m rate=30r/s;

  # Assets limit
  limit_req_zone $binary_remote_addr zone=assets:20m rate=100r/s;

  limit_req_status 429; # Too many requests

  # Limit body size
  client_max_body_size 10M;
  client_body_timeout 10s;

  include       mime.types;
  default_type  application/octet-stream;

  # Enables or disables the use of underscores in client request header fields.
  # When the use of underscores is disabled, request header fields whose names contain underscores are marked as invalid and become subject to the ignore_invalid_headers directive.
  # underscores_in_headers off;

  #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
  #                  '$status $body_bytes_sent "$http_referer" '
  #                  '"$http_user_agent" "$http_x_forwarded_for"';

  #access_log  logs/access.log  main;

  # Log in JSON Format
  log_format nginxlog_json escape=json '{ "timestamp": "$time_iso8601", '
  '"remote_addr": "$remote_addr", '
      '"body_bytes_sent": $body_bytes_sent, '
      '"request_time": $request_time, '
      '"response_status": $status, '
      '"request": "$request", '
      '"request_method": "$request_method", '
      '"host": "$host",'
      '"upstream_addr": "$upstream_addr",'
      '"http_x_forwarded_for": "$http_x_forwarded_for",'
      '"http_referrer": "$http_referer", '
      '"http_user_agent": "$http_user_agent", '
      '"http_version": "$server_protocol", '
      '"nginx_access": true }';
  access_log /dev/stdout nginxlog_json;

  geo $vpn_client {
      default 0;
      10.13.13.0/24 1;
  }

  # See Move default writable paths to a dedicated directory (#119)
  # https://github.com/openresty/docker-openresty/issues/119
  client_body_temp_path /var/run/openresty/nginx-client-body;
  proxy_temp_path       /var/run/openresty/nginx-proxy;
  fastcgi_temp_path     /var/run/openresty/nginx-fastcgi;
  uwsgi_temp_path       /var/run/openresty/nginx-uwsgi;
  scgi_temp_path        /var/run/openresty/nginx-scgi;

  sendfile        on;
  #tcp_nopush     on;

  #keepalive_timeout  0;
  keepalive_timeout  65;

  #gzip  on;

  ##
  # Global SSL Settings
  ##
  # Use only modern, secure protocols
  ssl_protocols TLSv1.2 TLSv1.3;

  # Use secure DH params (generated manually in entrypoint)
  ssl_dhparam /etc/openjanus/ssl/dhparam.pem;

  # Disable session tickets (prevents some PFS issues)
  ssl_session_tickets off;

  # Enable OCSP stapling (faster certificate validation)
  # ssl_stapling on;
  # ssl_stapling_verify on;
  # resolver 1.1.1.1 8.8.8.8 valid=300s;
  # resolver_timeout 5s;

  # Optional: Cache SSL sessions for performance
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 1h;

  # Strong cipher suites for TLS 1.2
  ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:EECDH+AESGCM:EDH+AESGCM';
  ssl_prefer_server_ciphers on;

  # Load all configs
  include /etc/nginx/conf.d/*.conf;

  # Don't reveal OpenResty version to clients.
  server_tokens off;

  # Remove server header
  more_clear_headers Server;

  # Can be disabled by overriding header
  more_set_headers 'Server: OpenJanus/$OPENJANUS_VERSION';
}

include /etc/nginx/conf.d/*.main;
